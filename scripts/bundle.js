// bundle.js — concatenate src/ modules into a single deployable Scriptable file.
// Output: dist/publix-agent.js
// Dependency order: config → parser → narrative → url → aisles → gpt → ui → main

const fs = require("fs");
const path = require("path");

const ORDER = [
  "config.js",
  "parser.js",
  "narrative.js",
  "url.js",
  "aisles.js",
  "gpt.js",
  "ui.js",
  "main.js"
];

const srcDir = path.join(__dirname, "..", "src");
const distDir = path.join(__dirname, "..", "dist");
const outFile = path.join(distDir, "publix-agent.js");

if (!fs.existsSync(distDir)) fs.mkdirSync(distDir, { recursive: true });

const banner = [
  "// publix-agent.js — auto-generated by scripts/bundle.js",
  "// DO NOT EDIT DIRECTLY. Edit src/ modules instead.",
  "// Paste this file into the Scriptable app on your iPhone.",
  ""
].join("\n");

// Inline require() calls: replace module.exports assignments and require() calls
// with a simple IIFE-per-module pattern.
function stripModuleBoilerplate(src, moduleName) {
  // Remove all local require() calls in any form:
  //   const Foo = require("./foo");
  //   const { a, b } = require("./foo");
  //   const {\n  a,\n  b\n} = require("./ui");
  let out = src.replace(/const\s+(?:\{[^}]*\}|\w+)\s*=\s*require\(["'][./][^"']*["']\);?\s*/gs, "");
  // Remove module.exports = { ... }; (multi-line)
  out = out.replace(/module\.exports\s*=\s*\{[^}]*\};\s*/gs, "");
  // Remove module.exports = IDENTIFIER;
  out = out.replace(/module\.exports\s*=\s*\w+;\s*/g, "");
  return `// --- ${moduleName} ---\n${out}\n`;
}

const parts = [banner];
for (const file of ORDER) {
  const src = fs.readFileSync(path.join(srcDir, file), "utf8");
  parts.push(stripModuleBoilerplate(src, file));
}

fs.writeFileSync(outFile, parts.join("\n"), "utf8");
console.log("Bundle written to", outFile, "(" + fs.statSync(outFile).size + " bytes)");
